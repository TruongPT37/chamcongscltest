<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://accounts.google.com/gsi/client" async></script>
  <title>Ch·∫•m c√¥ng</title>
  <style>
    body{font-family:system-ui;max-width:900px;margin:20px auto;padding:0 16px}
    fieldset{border:2px solid #2196F3;border-radius:12px;padding:20px;margin:20px 0;background:#f8f9fa}
    legend{color:#2196F3;font-weight:700;font-size:18px}
    .form-group{margin:12px 0}
    label{display:block;margin:6px 0 4px;font-weight:500}
    input,select,button{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;font-size:14px}
    button{background:#2196F3;color:#fff;border:none;cursor:pointer;font-weight:700}
    button:hover{background:#1976D2}
    button:disabled{background:#aaa;cursor:not-allowed}
    .hidden{display:none}
    .ok{color:green;font-weight:700}.err{color:#b00020;font-weight:700}
    #me{background:#e8f5e8;padding:10px;border-radius:8px;margin:12px 0}
    .calendar-container{background:#fff;border:1px solid #ddd;border-radius:10px;padding:12px}
    .month-year-selector{display:flex;gap:12px;margin-bottom:12px}
    .month-year-selector select{width:auto;flex:1}
    .calendar-day{padding:8px;border:1px solid #eee;min-height:36px;display:flex;align-items:center;justify-content:center;font-size:13px}
    .calendar-day.not-weekend{background:#f5f5f5;color:#999;cursor:not-allowed}
    .calendar-day:hover:not(.not-weekend){background:#e3f2fd;cursor:pointer}
    .calendar-day.selected{background:#2196F3;color:#fff;border-color:#1976D2}
  </style>
</head>
<body>
<h1 style="text-align:center;color:#2196F3">H·ªá th·ªëng ch·∫•m c√¥ng</h1>
<div id="g_id_onload"
     data-client_id="884894188365-cg2m31hli0pq1qp10dv7hnf4hshjju22.apps.googleusercontent.com"
     data-callback="onGoogle"></div>
<div id="btn" style="text-align:center;margin:16px 0"></div>
<p id="me" class="hidden"></p>

<div id="forms" class="hidden">
  <fieldset>
    <legend>üìÖ ƒêƒÉng k√Ω l·ªãch tr·ª±c (Th·ª© 7 / Ch·ªß nh·∫≠t)</legend>
    <div class="form-group">
      <label>Ch·ªçn th√°ng/nƒÉm</label>
      <div class="month-year-selector">
        <select id="monthSelect1"></select>
        <select id="yearSelect1"></select>
      </div>
    </div>
    <div class="form-group">
      <label>Ch·ªçn ng√†y tr·ª±c (ch·ªâ Th·ª© 7 ho·∫∑c Ch·ªß nh·∫≠t)</label>
      <div class="calendar-container">
        <div id="calendar1"></div>
        <div class="selected-dates" id="selectedDates1">Ch∆∞a ch·ªçn ng√†y n√†o</div>
      </div>
    </div>
    <div class="form-group">
      <label>Ghi ch√∫</label>
      <input id="note1" placeholder="T√πy ch·ªçn">
    </div>
    <button id="send1">ƒêƒÉng k√Ω l·ªãch tr·ª±c</button>
    <div id="msg1"></div>
  </fieldset>
</div>

<script>
const WEBHOOK_URL = "https://b9a42704daa1.ngrok-free.app/webhook-test/portal/submit";
let idToken=null,userEmail=null,selectedDates1=[],currentDate1=new Date();

function parseJWT(p){p=p.replace(/-/g,'+').replace(/_/g,'/');return JSON.parse(atob(p.padEnd(p.length+(4-p.length%4)%4,'=')))}
function isWeekend(d){const dt=new Date(d+'T00:00:00');return [0,6].includes(dt.getDay());}
function fmtDate(y,m,d){return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;}

function onGoogle(r){
  idToken=r.credential;
  const payload=parseJWT(idToken.split('.')[1]||'');
  userEmail=payload.email;
  document.getElementById('me').classList.remove('hidden');
  document.getElementById('me').innerHTML=`ƒêƒÉng nh·∫≠p: <b>${userEmail}</b>`;
  document.getElementById('forms').classList.remove('hidden');
  initSelectors();renderCalendar1();
}

window.onload=()=>{
  google.accounts.id.initialize({
    client_id:document.getElementById('g_id_onload').dataset.client_id,
    callback:onGoogle
  });
  google.accounts.id.renderButton(document.getElementById('btn'),{theme:"outline",size:"large",text:"signin_with"});
};

function initSelectors(){
  const yearSelect=document.getElementById('yearSelect1');
  const monthSelect=document.getElementById('monthSelect1');
  const yNow=new Date().getFullYear();
  for(let y=yNow-2;y<=yNow+2;y++){
    const opt=document.createElement('option');opt.value=y;opt.textContent=`NƒÉm ${y}`;
    if(y===yNow)opt.selected=true;yearSelect.appendChild(opt);
  }
  for(let m=0;m<12;m++){
    const opt=document.createElement('option');opt.value=m;opt.textContent=`Th√°ng ${m+1}`;
    if(m===new Date().getMonth())opt.selected=true;monthSelect.appendChild(opt);
  }
  monthSelect.addEventListener('change',()=>{currentDate1=new Date(yearSelect.value,monthSelect.value,1);selectedDates1=[];renderCalendar1();});
  yearSelect.addEventListener('change',()=>{currentDate1=new Date(yearSelect.value,monthSelect.value,1);selectedDates1=[];renderCalendar1();});
}

function renderCalendar1(){
  const cal=document.getElementById('calendar1');const y=currentDate1.getFullYear();const m=currentDate1.getMonth();
  const firstDay=new Date(y,m,1).getDay();const daysInMonth=new Date(y,m+1,0).getDate();
  let html='';for(let i=0;i<firstDay;i++)html+='<div></div>';
  for(let d=1;d<=daysInMonth;d++){const ds=fmtDate(y,m,d);const wk=isWeekend(ds);const sel=selectedDates1.includes(ds)?'selected':'';html+=`<div class="calendar-day ${wk?'':'not-weekend'} ${sel}" data-date="${ds}">${d}</div>`;}
  cal.innerHTML=html;
  document.querySelectorAll('#calendar1 .calendar-day').forEach(el=>{
    if(el.classList.contains('not-weekend'))return;
    el.addEventListener('click',()=>{
      const ds=el.dataset.date;const i=selectedDates1.indexOf(ds);
      if(i>=0){selectedDates1.splice(i,1);el.classList.remove('selected');}
      else{selectedDates1.push(ds);el.classList.add('selected');}
      updateSelectedDatesDisplay1();
    });
  });
  updateSelectedDatesDisplay1();
}

function updateSelectedDatesDisplay1(){
  const box=document.getElementById('selectedDates1');
  if(!selectedDates1.length){box.textContent='Ch∆∞a ch·ªçn ng√†y n√†o';return;}
  box.innerHTML='ƒê√£ ch·ªçn: '+selectedDates1.map(d=>{const [y,m,dd]=d.split('-');return `<span>${dd}/${m}/${y}</span>`}).join(' ');
}

async function postToWebhook(payload){
  const fd=new FormData();
  fd.append('id_token',idToken);
  fd.append('employeeId',userEmail);
  Object.entries(payload).forEach(([k,v])=>fd.append(k,v??''));
  const res=await fetch(WEBHOOK_URL,{method:'POST',body:fd});
  if(!res.ok)throw new Error(await res.text()||res.statusText);
  return res;
}

document.getElementById('send1').onclick=async()=>{
  const el=document.getElementById('msg1');const btn=document.getElementById('send1');
  const note=document.getElementById('note1').value;
  if(!selectedDates1.length){el.innerHTML='<span class="err">Ch·ªçn √≠t nh·∫•t m·ªôt ng√†y</span>';return;}
  const invalid=selectedDates1.filter(d=>!isWeekend(d));
  if(invalid.length){el.innerHTML='<span class="err">‚ùå Ph·∫£i ch·ªçn Th·ª© 7 ho·∫∑c Ch·ªß nh·∫≠t</span>';return;}
  btn.disabled=true;btn.textContent='‚è≥ ƒêang x·ª≠ l√Ω...';
  try{
    await postToWebhook({action:'shift',dates:selectedDates1.join(','),shiftType:'Day',note});
    el.innerHTML=`<span class="ok">‚úÖ ƒêƒÉng k√Ω l·ªãch tr·ª±c th√†nh c√¥ng cho ${selectedDates1.length} ng√†y</span>`;
    selectedDates1=[];renderCalendar1();
  }catch(e){el.innerHTML='<span class="err">‚ùå '+e.message+'</span>';}
  finally{btn.disabled=false;btn.textContent='ƒêƒÉng k√Ω l·ªãch tr·ª±c';}
};
</script>
</body>
</html>
