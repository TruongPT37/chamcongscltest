<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://accounts.google.com/gsi/client" async></script>
  <title>Ch·∫•m c√¥ng</title>
  <style>
    body{font-family:system-ui;max-width:900px;margin:20px auto;padding:0 16px}
    fieldset{border:2px solid #2196F3;border-radius:12px;padding:20px;margin:20px 0;background:#f8f9fa}
    legend{color:#2196F3;font-weight:700;font-size:18px}
    .form-group{margin:12px 0}
    label{display:block;margin:6px 0 4px;font-weight:500}
    input,select,button{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;font-size:14px}
    button{background:#2196F3;color:#fff;border:none;cursor:pointer;font-weight:700}
    button:hover{background:#1976D2}
    button:disabled{background:#aaa;cursor:not-allowed}
    .hidden{display:none}
    .ok{color:green;font-weight:700}.err{color:#b00020;font-weight:700}
    #me{background:#e8f5e8;padding:10px;border-radius:8px;margin:12px 0}
    .calendar-container{background:#fff;border:1px solid #ddd;border-radius:10px;padding:12px}
    .month-year-selector{display:flex;gap:12px;margin-bottom:12px}
    .month-year-selector select{width:auto;flex:1}
    .calendar-header{position:relative;margin-bottom:8px;text-align:center}
    .calendar-title{font-weight:700}
    .weekday-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-top:10px}
    .weekday{background:#f5f5f5;padding:6px 0;font-weight:700;font-size:12px;text-align:center}
    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;text-align:center}
    .calendar-day{padding:8px;border:1px solid #eee;background:#fff;cursor:pointer;min-height:36px;display:flex;align-items:center;justify-content:center;font-size:13px}
    .calendar-day.other-month{background:#fafafa;color:#bbb;cursor:default}
    .calendar-day:hover:not(.other-month){background:#e3f2fd}
    .calendar-day.selected{background:#2196F3;color:#fff;border-color:#1976D2}
    .selected-dates{margin-top:8px;font-size:12px;color:#555}
    .selected-dates span{background:#e3f2fd;padding:2px 6px;border-radius:4px;margin:2px;display:inline-block}
    @media (max-width:600px){ .month-year-selector{flex-direction:column} }
  </style>
</head>
<body>
  <h1 style="text-align:center;color:#2196F3">H·ªá th·ªëng ch·∫•m c√¥ng</h1>

  <div id="g_id_onload"
       data-client_id="884894188365-cg2m31hli0pq1qp10dv7hnf4hshjju22.apps.googleusercontent.com"
       data-callback="onGoogle"></div>
  <div id="btn" style="text-align:center;margin:16px 0"></div>
  <p id="me" class="hidden"></p>

  <div id="forms" class="hidden">
    <fieldset>
      <legend>üìÖ ƒêƒÉng k√Ω l·ªãch tr·ª±c</legend>
      <div class="form-group">
        <label>Ng√†y tr·ª±c</label>
        <input id="date1" type="date">
      </div>
      <div class="form-group">
        <label>Ghi ch√∫</label>
        <input id="note1" placeholder="T√πy ch·ªçn">
      </div>
      <button id="send1">ƒêƒÉng k√Ω l·ªãch tr·ª±c</button>
      <div id="msg1"></div>
    </fieldset>

    <fieldset>
      <legend>‚è∞ Ch·∫•m c√¥ng ng√†y th∆∞·ªùng</legend>
      <div class="form-group">
        <label>Ch·ªçn th√°ng/nƒÉm</label>
        <div class="month-year-selector">
          <select id="monthSelect">
            <option value="0">Th√°ng 1</option><option value="1">Th√°ng 2</option><option value="2">Th√°ng 3</option>
            <option value="3">Th√°ng 4</option><option value="4">Th√°ng 5</option><option value="5">Th√°ng 6</option>
            <option value="6">Th√°ng 7</option><option value="7">Th√°ng 8</option><option value="8">Th√°ng 9</option>
            <option value="9">Th√°ng 10</option><option value="10">Th√°ng 11</option><option value="11">Th√°ng 12</option>
          </select>
          <select id="yearSelect"></select>
        </div>
      </div>
      <div class="form-group">
        <label>Ch·ªçn ng√†y (c√≥ th·ªÉ ch·ªçn nhi·ªÅu)</label>
        <div class="calendar-container">
          <div class="calendar-header">
            <div class="calendar-title" id="currentMonth2">Th√°ng ?</div>
          </div>
          <div class="weekday-grid" id="weekday2"></div>
          <div class="calendar-grid" id="calendar2"></div>
          <div class="selected-dates" id="selectedDates2">Ch∆∞a ch·ªçn ng√†y n√†o</div>
        </div>
      </div>
      <div class="form-group">
        <label>Ghi ch√∫</label>
        <input id="note2" placeholder="T√πy ch·ªçn">
      </div>
      <button id="send2">Ghi nh·∫≠n ch·∫•m c√¥ng</button>
      <div id="msg2"></div>
    </fieldset>

    <fieldset>
      <legend>üïê Ch·∫•m c√¥ng l√†m th√™m</legend>
      <div class="form-group">
        <label>Ng√†y l√†m th√™m</label>
        <input id="date3" type="date">
      </div>
      <div class="form-group" style="display:flex;gap:12px">
        <div style="flex:1">
          <label>B·∫Øt ƒë·∫ßu</label>
          <input id="startTime3" type="time">
        </div>
        <div style="flex:1">
          <label>K·∫øt th√∫c</label>
          <input id="endTime3" type="time">
        </div>
      </div>
      <div class="form-group">
        <label>Ghi ch√∫</label>
        <input id="note3" placeholder="M√¥ t·∫£ c√¥ng vi·ªác l√†m th√™m">
      </div>
      
      <div class="form-group">
        <label>·∫¢nh minh ch·ª©ng (T√πy ch·ªçn)</label>
        <input id="pic3" type="file" accept="image/*">
      </div>
      <button id="send3">Ghi nh·∫≠n l√†m th√™m</button>
      <div id="msg3"></div>
    </fieldset>
  </div>

<script>
  // ==== CONFIG ====
  // !!! BOSS H√ÉY D√ÅN URL /exec M·ªöI C·ª¶A M√åNH V√ÄO ƒê√ÇY !!!
  const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbxvfmvk35QHIvBzeLaNl0Qq0T-OBnYKD5SsIrEX-uEevWFWhOB7TE7R966J-Y5gtBbz/exec"; 
  // ================

  let idToken = null;
  let userEmail = null;
  let selectedDates2 = [];
  let currentDate2 = new Date();

  function parseJWT(p){
    p=p.replace(/-/g,'+').replace(/_/g,'/');
    return JSON.parse(atob(p.padEnd(p.length+ (4-p.length%4)%4,'=')))
  }

  function onGoogle(r){
    idToken = r.credential;
    const payload = parseJWT(idToken.split('.')[1]||'');
    userEmail = payload.email;
    document.getElementById('me').classList.remove('hidden');
    document.getElementById('me').innerHTML = `ƒêƒÉng nh·∫≠p: <b>${userEmail}</b>`;
    document.getElementById('forms').classList.remove('hidden');
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date1').value = today;
    document.getElementById('date3').value = today;
    initYearSelector();
    renderCalendar2();
  }

  window.onload = ()=>{
    google.accounts.id.initialize({
      client_id: document.getElementById('g_id_onload').dataset.client_id,
      callback: onGoogle
    });
    google.accounts.id.renderButton(document.getElementById('btn'), { theme:"outline", size:"large", text:"signin_with" });
  };

  // ====== Calendar Functions (No change) ======
  function initYearSelector(){
    const yearSelect = document.getElementById('yearSelect');
    const currentYear = new Date().getFullYear();
    for(let y = currentYear - 2; y <= currentYear + 2; y++){
      const opt = document.createElement('option');
      opt.value = y;
      opt.textContent = `NƒÉm ${y}`;
      if(y === currentYear) opt.selected = true;
      yearSelect.appendChild(opt);
    }
    document.getElementById('monthSelect').value = new Date().getMonth();
    document.getElementById('monthSelect').addEventListener('change', onMonthYearChange);
    document.getElementById('yearSelect').addEventListener('change', onMonthYearChange);
  }
  function onMonthYearChange(){
    const month = parseInt(document.getElementById('monthSelect').value);
    const year = parseInt(document.getElementById('yearSelect').value);
    currentDate2 = new Date(year, month, 1);
    selectedDates2 = []; 
    renderCalendar2();
  }
  function renderCalendar2(){
    const year = currentDate2.getFullYear();
    const month = currentDate2.getMonth();
    document.getElementById('monthSelect').value = month;
    document.getElementById('yearSelect').value = year;
    const monthNames = ["Th√°ng 1","Th√°ng 2","Th√°ng 3","Th√°ng 4","Th√°ng 5","Th√°ng 6","Th√°ng 7","Th√°ng 8","Th√°ng 9","Th√°ng 10","Th√°ng 11","Th√°ng 12"];
    document.getElementById('currentMonth2').textContent = `${monthNames[month]} ${year}`;
    const dayHeaders = ['CN','T2','T3','T4','T5','T6','T7'];
    document.getElementById('weekday2').innerHTML = dayHeaders.map(d=>`<div class="weekday">${d}</div>`).join('');
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month+1, 0).getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();
    let html = '';
    for(let i = firstDay - 1; i >= 0; i--){ html += `<div class="calendar-day other-month">${daysInPrevMonth - i}</div>`; }
    for(let d=1; d<=daysInMonth; d++){
      const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const selected = selectedDates2.includes(dateStr) ? 'selected':'';
      html += `<div class="calendar-day ${selected}" data-date="${dateStr}">${d}</div>`;
    }
    const totalCells = Math.ceil((firstDay + daysInMonth)/7)*7;
    const remain = totalCells - (firstDay + daysInMonth);
    for(let d=1; d<=remain; d++){ html += `<div class="calendar-day other-month">${d}</div>`; }
    document.getElementById('calendar2').innerHTML = html;
    document.querySelectorAll('#calendar2 .calendar-day:not(.other-month)').forEach(el=>{
      el.addEventListener('click', ()=>{
        const date = el.getAttribute('data-date');
        const idx = selectedDates2.indexOf(date);
        if(idx>=0){ selectedDates2.splice(idx,1); el.classList.remove('selected'); }
        else { selectedDates2.push(date); el.classList.add('selected'); }
        updateSelectedDatesDisplay2();
      });
    });
    updateSelectedDatesDisplay2();
  }
  function updateSelectedDatesDisplay2(){
    const box = document.getElementById('selectedDates2');
    if(selectedDates2.length===0){ box.textContent = 'Ch∆∞a ch·ªçn ng√†y n√†o'; return; }
    const s = selectedDates2.slice().sort().map(dt=>{
      const [y,m,d] = dt.split('-'); return `<span>${d}/${m}/${y}</span>`;
    }).join(' ');
    box.innerHTML = `ƒê√£ ch·ªçn: ${s}`;
  }
  // ====== End Calendar Functions ======


  // G·ª≠i JSON, kh√¥ng d√πng FormData
  async function postToServer(payload) {
    try {
      const res = await fetch(WEBHOOK_URL, { 
        method: 'POST', 
        headers: { 'Content-Type': 'text/plain' }, 
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok || data.status === 'error') {
        throw new Error(data.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ server');
      }
      return data;
    } catch (e) {
      throw new Error(`L·ªói m·∫°ng: ${e.message}`);
    }
  }

  // Chuy·ªÉn file sang Base64
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = error => reject(error);
    });
  }


  // 1) Shift register
  document.getElementById('send1').onclick = async ()=>{
    const el = document.getElementById('msg1');
    const btn = document.getElementById('send1');
    const payload = {
      action: 'shift', id_token: idToken, employeeId: userEmail,
      shiftDate: document.getElementById('date1').value,
      shiftType: 'Day', 
      note: document.getElementById('note1').value
    };
    if(!payload.shiftDate){ el.innerHTML = '<span class="err">Ch·ªçn ng√†y tr·ª±c</span>'; return; }
    btn.disabled = true; btn.textContent = '‚è≥ ƒêang x·ª≠ l√Ω...';
    try{
      const resData = await postToServer(payload);
      el.innerHTML = '<span class="ok">‚úÖ ' + resData.message + '</span>';
    }catch(e){ el.innerHTML = '<span class="err">‚ùå ' + e.message + '</span>'; } 
    finally { btn.disabled = false; btn.textContent = 'ƒêƒÉng k√Ω l·ªãch tr·ª±c'; }
  };

  // 2) Attendance
  document.getElementById('send2').onclick = async ()=>{
    const el = document.getElementById('msg2');
    const btn = document.getElementById('send2');
    if(selectedDates2.length === 0){ el.innerHTML = '<span class="err">Ch·ªçn √≠t nh·∫•t m·ªôt ng√†y</span>'; return; }
    const payload = {
      action: 'attendance', id_token: idToken, employeeId: userEmail,
      dates: selectedDates2.join(','),
      note: document.getElementById('note2').value
    };
    btn.disabled = true; btn.textContent = '‚è≥ ƒêang x·ª≠ l√Ω...';
    try {
      const resData = await postToServer(payload);
      el.innerHTML = `<span class="ok">‚úÖ ${resData.message}</span>`;
      selectedDates2 = [];
      renderCalendar2();
    } catch (e) { el.innerHTML = `<span class="err">‚ùå ${e.message}</span>`; } 
    finally { btn.disabled = false; btn.textContent = 'Ghi nh·∫≠n ch·∫•m c√¥ng'; }
  };

  /*
   * =============================================
   * THAY ƒê·ªîI LOGIC: X·ª¨ L√ù ·∫¢NH KH√îNG B·∫ÆT BU·ªòC
   * =============================================
   */
  document.getElementById('send3').onclick = async ()=>{
    const el = document.getElementById('msg3');
    const btn = document.getElementById('send3');

    const date = document.getElementById('date3').value;
    const start = document.getElementById('startTime3').value;
    const end = document.getElementById('endTime3').value;
    const note = document.getElementById('note3').value;
    const photo = document.getElementById('pic3').files[0]; // S·∫Ω l√† 'undefined' n·∫øu kh√¥ng ch·ªçn

    // 1. THAY ƒê·ªîI: B·ªè check 'photo'
    if(!date || !start || !end){ el.innerHTML = '<span class="err">Nh·∫≠p ƒë·ªß th√¥ng tin Ng√†y, B·∫Øt ƒë·∫ßu, K·∫øt th√∫c</span>'; return; }
    if(start>=end){ el.innerHTML = '<span class="err">B·∫Øt ƒë·∫ßu ph·∫£i nh·ªè h∆°n k·∫øt th√∫c</span>'; return; }
    
    btn.disabled = true;
    btn.textContent = '‚è≥ ƒêang x·ª≠ l√Ω...';
    
    try{
      // 2. T·∫°o payload JSON c∆° b·∫£n
      const payload = {
        action: 'ot',
        id_token: idToken,
        employeeId: userEmail,
        date: date,
        start: start,
        end: end,
        reason: note,
        // C√°c tr∆∞·ªùng photo (photo_base64, photo_name, photo_type) 
        // s·∫Ω ƒë∆∞·ª£c th√™m v√†o B√äN D∆Ø·ªöI n·∫øu c√≥
      };

      // 3. THAY ƒê·ªîI: Ch·ªâ x·ª≠ l√Ω ·∫£nh n·∫øu ng∆∞·ªùi d√πng ch·ªçn
      if (photo) {
        btn.textContent = '‚è≥ ƒêang x·ª≠ l√Ω (M√£ h√≥a ·∫£nh)...';
        const photo_base64 = await fileToBase64(photo);
        // Th√™m th√¥ng tin ·∫£nh v√†o payload
        payload.photo_base64 = photo_base64;
        payload.photo_name = photo.name;
        payload.photo_type = photo.type;
      } else {
        btn.textContent = '‚è≥ ƒêang t·∫£i l√™n...';
        // Kh√¥ng l√†m g√¨, payload s·∫Ω ƒë∆∞·ª£c g·ª≠i ƒëi m√† kh√¥ng c√≥ th√¥ng tin ·∫£nh
      }

      // 4. G·ª≠i ƒëi
      const resData = await postToServer(payload);
      el.innerHTML = '<span class="ok">‚úÖ ' + resData.message + '</span>';
      document.getElementById('pic3').value = null; // X√≥a file ƒë√£ ch·ªçn
      
    }catch(e){ 
      el.innerHTML = '<span class="err">‚ùå ' + e.message + '</span>'; 
    } finally {
      btn.disabled = false;
      btn.textContent = 'Ghi nh·∫≠n l√†m th√™m';
    }
  };
  // =============================================
  // K·∫æT TH√öC THAY ƒê·ªîI
  // =============================================
</script>
</body>
</html>
