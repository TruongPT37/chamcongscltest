<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://accounts.google.com/gsi/client" async></script>
  <title>Ch·∫•m c√¥ng - ƒêƒÉng k√Ω l·ªãch tr·ª±c (Batch)</title>
  <style>
    :root{--pri:#2196F3;--pri2:#1976D2;}
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;max-width:920px;margin:24px auto;padding:0 16px;background:#fafafa}
    h1{color:var(--pri);text-align:center}
    fieldset{border:2px solid var(--pri);border-radius:16px;padding:18px 18px 22px;background:#fff}
    legend{color:var(--pri);font-weight:700;padding:0 6px}
    .hidden{display:none}
    .ok{color:#2e7d32;font-weight:700}
    .err{color:#b00020;font-weight:700}
    #me{background:#e8f5e8;border:1px solid #c8e6c9;border-radius:10px;padding:10px;margin:12px 0}
    button{display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border:none;border-radius:10px;background:var(--pri);color:#fff;font-weight:700;cursor:pointer}
    button:hover{background:var(--pri2)}
    button:disabled{background:#9e9e9e;cursor:not-allowed}
    input[type="text"]{width:100%;padding:10px;border:1px solid #ccc;border-radius:10px}
    .cal{user-select:none;background:#fff;border:1px solid #e0e0e0;border-radius:14px;padding:12px}
    .cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .cal-title{font-weight:800}
    .nav-btn{background:transparent;border:1px solid #ddd;border-radius:8px;padding:6px 10px;color:#444;cursor:pointer}
    .nav-btn:hover{background:#f1f5ff}
    .weekday{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin:6px 0 8px}
    .weekday div{font-weight:600;text-align:center;color:#616161}
    .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
    .cell{height:42px;border:1px solid #eee;border-radius:8px;display:flex;align-items:center;justify-content:center;background:#fff;color:#424242}
    .cell.muted{background:#fafafa;color:#bdbdbd}
    .cell.day{cursor:not-allowed;background:#f5f5f5;color:#9e9e9e}
    .cell.weekend{cursor:pointer;background:#fff;color:#424242}
    .cell.weekend:hover{background:#e3f2fd}
    .cell.selected{background:var(--pri);color:#fff;border-color:var(--pri2)}
    .selected-badge{margin-top:8px;font-size:13px;color:#555}
    .selected-badge span{background:#e3f2fd;border:1px solid #bbdefb;padding:2px 6px;border-radius:6px;margin:2px;display:inline-block}
  </style>
</head>
<body>
  <h1>H·ªá th·ªëng ch·∫•m c√¥ng</h1>

  <div id="g_id_onload"
       data-client_id="884894188365-cg2m31hli0pq1qp10dv7hnf4hshjju22.apps.googleusercontent.com"
       data-callback="onGoogle"></div>
  <div id="btn" style="text-align:center;margin:16px 0"></div>
  <p id="me" class="hidden"></p>

  <fieldset id="formBox" class="hidden">
    <legend>üìÖ ƒêƒÉng k√Ω l·ªãch tr·ª±c (ch·ªâ Th·ª© 7 / Ch·ªß nh·∫≠t)</legend>

    <div class="cal">
      <div class="cal-header">
        <button id="prev" class="nav-btn">‚óÄ</button>
        <div class="cal-title" id="calTitle">Th√°ng ? NƒÉm ?</div>
        <button id="next" class="nav-btn">‚ñ∂</button>
      </div>
      <div class="weekday">
        <div>Su</div><div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div>
      </div>
      <div class="grid" id="grid"></div>
      <div class="selected-badge" id="badge">Ch∆∞a ch·ªçn ng√†y n√†o</div>
    </div>

    <div style="margin-top:12px">
      <label for="note1" style="display:block;margin:6px 0 4px;font-weight:500">Ghi ch√∫</label>
      <input id="note1" type="text" placeholder="T√πy ch·ªçn">
    </div>

    <div style="margin-top:14px">
      <button id="send">ƒêƒÉng k√Ω l·ªãch tr·ª±c</button>
      <span id="msg" style="margin-left:10px"></span>
    </div>
  </fieldset>

<script>
const WEBHOOK_URL = "https://b9a42704daa1.ngrok-free.app/webhook-test/670963d4-9a84-48c7-ad09-9ff064830929";
let idToken=null,userEmail=null;
let viewDate=new Date();       // th√°ng ƒëang hi·ªÉn th·ªã
let selected=new Set();        // c√°c ng√†y ƒë√£ ch·ªçn (YYYY-MM-DD)

function parseJWT(p){p=p.replace(/-/g,'+').replace(/_/g,'/');return JSON.parse(atob(p.padEnd(p.length+(4-p.length%4)%4,'=')))}
function ymd(y,m,d){return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`}
function isWeekendStr(ds){const t=new Date(ds+'T00:00:00');return [0,6].includes(t.getDay());}

function onGoogle(r){
  idToken=r.credential;
  const payload=parseJWT(idToken.split('.')[1]||'');
  userEmail=payload.email;
  document.getElementById('me').classList.remove('hidden');
  document.getElementById('me').innerHTML=`ƒêƒÉng nh·∫≠p: <b>${userEmail}</b>`;
  document.getElementById('formBox').classList.remove('hidden');
  render();
}
window.onload=()=>{
  google.accounts.id.initialize({
    client_id:document.getElementById('g_id_onload').dataset.client_id,
    callback:onGoogle
  });
  google.accounts.id.renderButton(document.getElementById('btn'),{theme:"outline",size:"large",text:"signin_with"});
  document.getElementById('prev').onclick=()=>{viewDate.setMonth(viewDate.getMonth()-1);render();}
  document.getElementById('next').onclick=()=>{viewDate.setMonth(viewDate.getMonth()+1);render();}
  document.getElementById('send').onclick=submitBatch;
};

function render(){
  const y=viewDate.getFullYear(), m=viewDate.getMonth();
  document.getElementById('calTitle').textContent=new Intl.DateTimeFormat('en-US',{month:'long',year:'numeric'}).format(viewDate);
  const first=new Date(y,m,1);
  const startIdx=first.getDay(); const daysInMonth=new Date(y,m+1,0).getDate(); const prevMonthDays=new Date(y,m,0).getDate();
  const grid=document.getElementById('grid'); grid.innerHTML='';

  for(let i=startIdx-1;i>=0;i--){ const d=prevMonthDays-i; const cell=document.createElement('div'); cell.className='cell muted'; cell.textContent=d; grid.appendChild(cell); }
  for(let d=1;d<=daysInMonth;d++){ const ds=ymd(y,m,d); const wk=isWeekendStr(ds); const cell=document.createElement('div'); cell.className='cell '+(wk?'weekend':'day')+(selected.has(ds)?' selected':''); cell.textContent=d;
    if(wk){ cell.onclick=()=>{ if(selected.has(ds)){selected.delete(ds);cell.classList.remove('selected');} else {selected.add(ds);cell.classList.add('selected');} updateBadge(); }; }
    grid.appendChild(cell);
  }
  while(grid.children.length%7!==0){ const cell=document.createElement('div'); cell.className='cell muted'; cell.textContent=''; grid.appendChild(cell); }
  updateBadge();
}
function updateBadge(){
  const b=document.getElementById('badge');
  if(!selected.size){b.textContent='Ch∆∞a ch·ªçn ng√†y n√†o';return;}
  const arr=[...selected].sort();
  b.innerHTML='ƒê√£ ch·ªçn: '+arr.map(s=>{const [Y,M,D]=s.split('-');return `<span>${D}/${M}/${Y}</span>`;}).join(' ');
}

// G·ª≠i 1 request duy nh·∫•t: dates="YYYY-MM-DD,YYYY-MM-DD,..."
async function submitBatch(){
  const msg=document.getElementById('msg'); const btn=document.getElementById('send');
  if(!selected.size){msg.innerHTML='<span class="err">Ch·ªçn √≠t nh·∫•t m·ªôt ng√†y</span>';return;}
  btn.disabled=true; btn.textContent='‚è≥ ƒêang g·ª≠i...'; msg.textContent='';
  const note=document.getElementById('note1').value;
  try{
    const fd=new FormData();
    fd.append('id_token',idToken);
    fd.append('employeeId',userEmail);
    fd.append('action','shift');
    fd.append('shiftType','Day');
    fd.append('note',note||'');
    fd.append('dates',[...selected].sort().join(',')); // CSV
    const res=await fetch(WEBHOOK_URL,{method:'POST',body:fd});
    if(!res.ok) throw new Error(await res.text()||res.statusText);
    msg.innerHTML=`<span class="ok">‚úÖ G·ª≠i th√†nh c√¥ng ${selected.size} ng√†y</span>`;
    selected.clear(); render();
  }catch(e){ msg.innerHTML=`<span class="err">‚ùå ${e.message}</span>`; }
  finally{ btn.disabled=false; btn.textContent='ƒêƒÉng k√Ω l·ªãch tr·ª±c'; }
}
</script>
</body>
</html>
